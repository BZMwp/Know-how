<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Campus · 校园聊天</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Inter', 'Segoe UI', sans-serif;
    }

    :root {
      --primary: #3b82f6;
      --primary-dark: #2563eb;
      --primary-light: #60a5fa;
      --secondary: #8b5cf6;
      --bg-dark: #0f172a;
      --bg-card: #1e293b;
      --bg-sidebar: #121218;
      --bg-hover: rgba(59, 130, 246, 0.1);
      --text-primary: #f1f5f9;
      --text-secondary: #cbd5e1;
      --text-muted: #94a3b8;
      --border: rgba(255,255,255,0.1);
      --radius-sm: 12px;
      --radius-md: 16px;
      --radius-lg: 20px;
      --radius-full: 999px;
      --transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    }

    body {
      background: var(--bg-dark);
      color: var(--text-primary);
      min-height: 100vh;
      line-height: 1.6;
      overflow-x: hidden;
    }

    ::-webkit-scrollbar { width: 4px; height: 4px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: var(--radius-full); }
    ::-webkit-scrollbar-thumb:hover { background: var(--primary); }

    .toast {
      position: fixed; top: 80px; left: 50%;
      transform: translateX(-50%) translateY(-20px);
      background: var(--bg-card); border: 1px solid var(--border);
      padding: 12px 24px; border-radius: var(--radius-md);
      color: var(--text-primary); box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      z-index: 99999; opacity: 0; visibility: hidden; transition: var(--transition);
    }
    .toast.show { opacity: 1; visibility: visible; transform: translateX(-50%) translateY(0); }
    .toast.error { border-left: 4px solid #ef4444; }
    .toast.success { border-left: 4px solid #10b981; }
    .toast.warning { border-left: 4px solid #f59e0b; }

    .modal {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center;
      z-index: 99999; opacity: 0; visibility: hidden; transition: var(--transition);
    }
    .modal.show { opacity: 1; visibility: visible; }
    .modal-content {
      background: var(--bg-card); border: 1px solid var(--border);
      border-radius: var(--radius-lg); padding: 30px; width: 90%; max-width: 400px;
    }
    .modal-title { font-size: 18px; margin-bottom: 20px; text-align: center; }

    .auth-wrapper {
      min-height: 100vh; width: 100%; display: flex; align-items: center; justify-content: center;
      padding: 20px; background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
      position: fixed; top: 0; left: 0; z-index: 9999;
    }
    .auth-wrapper.hidden { display: none !important; }
    .auth-box {
      width: 100%; max-width: 420px; background: rgba(30, 41, 59, 0.8);
      backdrop-filter: blur(20px); border: 1px solid var(--border);
      border-radius: var(--radius-lg); padding: 40px 32px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3); display: none;
    }
    .auth-box.active { display: block; animation: fadeUp 0.4s ease; }
    @keyframes fadeUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    .auth-header { text-align: center; margin-bottom: 32px; }
    .auth-header .logo {
      width: 70px; height: 70px; background: linear-gradient(135deg, var(--primary), var(--secondary));
      border-radius: var(--radius-md); display: inline-flex; align-items: center; justify-content: center;
      font-size: 32px; color: white; margin-bottom: 16px;
    }
    .auth-header h2 { font-size: 28px; font-weight: 700; margin-bottom: 8px; }
    .auth-header p { color: var(--text-muted); font-size: 14px; }
    .form-group { margin-bottom: 20px; }
    .form-label { display: block; margin-bottom: 8px; font-size: 14px; font-weight: 500; color: var(--text-secondary); }
    .form-input {
      width: 100%; padding: 14px 16px; background: rgba(15, 23, 42, 0.6);
      border: 1px solid var(--border); border-radius: var(--radius-sm);
      color: var(--text-primary); font-size: 15px; outline: none; transition: var(--transition);
    }
    .form-input:focus { border-color: var(--primary); }
    .btn {
      width: 100%; padding: 14px; border-radius: var(--radius-sm); border: none;
      font-size: 15px; font-weight: 600; cursor: pointer; transition: var(--transition);
      display: inline-flex; align-items: center; justify-content: center; gap: 8px; text-decoration: none;
    }
    .btn-primary { background: linear-gradient(90deg, var(--primary), var(--primary-dark)); color: white; }
    .btn-primary:hover { transform: translateY(-2px); }
    .btn-sm { padding: 8px 16px; font-size: 14px; width: auto; }
    .auth-footer { text-align: center; margin-top: 24px; font-size: 14px; color: var(--text-muted); }
    .auth-footer span { color: var(--primary-light); cursor: pointer; font-weight: 500; }

    .app-container { display: none; width: 100%; height: 100vh; overflow: hidden; }
    .app-container.active { display: flex; animation: fadeIn 0.3s ease; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    .chat-sidebar {
      width: 280px; height: 100vh; background: var(--bg-sidebar);
      border-right: 1px solid var(--border); display: flex; flex-direction: column; flex-shrink: 0;
    }
    .sidebar-header { padding: 20px 16px; border-bottom: 1px solid var(--border); }
    .user-info-bar { display: flex; align-items: center; gap: 12px; margin-bottom: 16px; }
    .user-avatar {
      width: 44px; height: 44px; border-radius: var(--radius-full);
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; flex-shrink: 0;
    }
    .user-name { font-weight: 600; font-size: 15px; flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .search-box {
      width: 100%; padding: 10px 14px; background: rgba(15, 23, 42, 0.6);
      border: 1px solid var(--border); border-radius: var(--radius-sm);
      color: var(--text-primary); outline: none; font-size: 14px;
    }
    .sidebar-tabs { display: flex; border-bottom: 1px solid var(--border); }
    .sidebar-tab {
      flex: 1; text-align: center; padding: 12px 0; font-size: 14px; font-weight: 500;
      color: var(--text-muted); cursor: pointer; border-bottom: 2px solid transparent; transition: var(--transition);
    }
    .sidebar-tab.active { color: var(--primary-light); border-bottom-color: var(--primary); }
    .session-wrap { flex: 1; overflow-y: auto; }
    .session-group { padding: 8px; }
    .group-title { font-size: 12px; color: var(--text-muted); font-weight: 600; padding: 8px; text-transform: uppercase; letter-spacing: 0.5px; }
    .session-item {
      padding: 10px 8px; border-radius: var(--radius-sm); cursor: pointer; transition: var(--transition);
      display: flex; align-items: center; gap: 12px; position: relative; margin-bottom: 4px;
    }
    .session-item:hover, .session-item.active { background: var(--bg-hover); }
    .session-avatar {
      width: 44px; height: 44px; border-radius: var(--radius-full);
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; flex-shrink: 0;
    }
    .session-info { flex: 1; min-width: 0; }
    .session-name { font-weight: 500; font-size: 14px; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .session-last-msg { font-size: 12px; color: var(--text-muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .session-meta { display: flex; flex-direction: column; align-items: flex-end; gap: 4px; flex-shrink: 0; }
    .session-time { font-size: 11px; color: var(--text-muted); }
    .unread-badge {
      min-width: 18px; height: 18px; border-radius: var(--radius-full); background: #ef4444;
      color: white; font-size: 11px; font-weight: 600; display: flex; align-items: center; justify-content: center; padding: 0 4px;
    }

    .chat-main { flex: 1; height: 100vh; display: flex; flex-direction: column; background: var(--bg-dark); }
    .chat-header {
      padding: 16px 24px; border-bottom: 1px solid var(--border); background: var(--bg-card);
      display: flex; align-items: center; gap: 12px; flex-shrink: 0;
    }
    .chat-header-avatar {
      width: 44px; height: 44px; border-radius: var(--radius-full);
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      display: flex; align-items: center; justify-content: center; color: white; font-weight: 600;
    }
    .chat-header-info h4 { font-size: 15px; font-weight: 600; margin-bottom: 2px; }
    .chat-header-status { font-size: 12px; color: #10b981; }
    .chat-content { flex: 1; padding: 24px; overflow-y: auto; display: flex; flex-direction: column; gap: 20px; }
    .chat-empty { height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--text-muted); gap: 16px; }
    .chat-empty i { font-size: 64px; opacity: 0.2; }
    .time-split {
      text-align: center; font-size: 12px; color: var(--text-muted); margin: 8px 0;
      padding: 4px 12px; background: rgba(255,255,255,0.05); border-radius: var(--radius-full);
      width: fit-content; margin-left: auto; margin-right: auto;
    }
    .message-item { display: flex; gap: 12px; max-width: 70%; animation: messageFade 0.2s ease; }
    @keyframes messageFade { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .message-item.self { align-self: flex-end; flex-direction: row-reverse; }
    .message-avatar {
      width: 36px; height: 36px; border-radius: var(--radius-full);
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; flex-shrink: 0;
    }
    .message-bubble-wrap { display: flex; flex-direction: column; }
    .message-bubble {
      padding: 12px 16px; border-radius: var(--radius-md); background: var(--bg-card);
      color: var(--text-primary); font-size: 14px; line-height: 1.6; word-break: break-word;
    }
    .message-item.self .message-bubble { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; border-bottom-right-radius: 4px; }
    .message-item:not(.self) .message-bubble { border-bottom-left-radius: 4px; }
    .message-time { font-size: 11px; color: var(--text-muted); margin-top: 4px; padding: 0 4px; }
    .message-item.self .message-time { text-align: left; }
    .message-item.self .message-bubble-wrap { align-items: flex-end; }
    .chat-input-box { padding: 16px 24px; border-top: 1px solid var(--border); background: var(--bg-card); flex-shrink: 0; }
    .chat-input-wrapper { display: flex; gap: 12px; align-items: flex-end; }
    .chat-input {
      flex: 1; padding: 14px 16px; background: rgba(15, 23, 42, 0.6);
      border: 1px solid var(--border); border-radius: var(--radius-sm);
      color: var(--text-primary); outline: none; font-size: 14px; resize: none;
      min-height: 50px; max-height: 120px; line-height: 1.5; transition: var(--transition);
    }
    .chat-input:focus { border-color: var(--primary); }
    .send-btn {
      padding: 14px 24px; background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      border: none; border-radius: var(--radius-sm); color: white; cursor: pointer;
      transition: var(--transition); font-weight: 600;
    }
    .send-btn:hover { transform: scale(1.05); }

    .main-nav { display: none; padding: 16px 20px; background: var(--bg-sidebar); border-bottom: 1px solid var(--border); gap: 8px; overflow-x: auto; }
    .main-nav-item {
      padding: 10px 18px; border-radius: var(--radius-sm); color: var(--text-secondary);
      font-size: 14px; font-weight: 500; cursor: pointer; transition: var(--transition);
      border: none; background: transparent; white-space: nowrap;
    }
    .main-nav-item.active { background: var(--bg-hover); color: var(--primary-light); }

    .community-page { padding: 24px; height: 100vh; overflow-y: auto; display: none; }
    .community-page.active { display: block; }
    .card {
      background: var(--bg-card); border-radius: var(--radius-lg); border: 1px solid var(--border);
      padding: 24px; margin-bottom: 20px;
    }
    .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 12px; }
    .card-title { font-size: 20px; font-weight: 600; color: var(--text-primary); display: flex; align-items: center; gap: 10px; }
    .card-title i { color: var(--primary); }
    .publish-input {
      width: 100%; background: rgba(15, 23, 42, 0.6); border: 1px solid var(--border);
      border-radius: var(--radius-md); padding: 16px; color: var(--text-primary);
      font-size: 15px; outline: none; margin-bottom: 12px; resize: none;
    }
    .publish-footer { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px; }
    .tag-select { display: flex; gap: 8px; flex-wrap: wrap; }
    .tag-item {
      padding: 6px 12px; background: rgba(255,255,255,0.05); border-radius: var(--radius-full);
      font-size: 13px; color: var(--text-secondary); cursor: pointer; transition: var(--transition);
    }
    .tag-item:hover, .tag-item.active { background: var(--bg-hover); color: var(--primary-light); }
    .post-item {
      padding: 20px; background: var(--bg-card); border-radius: var(--radius-lg);
      border: 1px solid var(--border); margin-bottom: 16px;
    }
    .post-header { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; }
    .post-username { font-weight: 600; color: var(--text-primary); font-size: 15px; }
    .post-time { font-size: 12px; color: var(--text-muted); }
    .post-tag { padding: 4px 10px; background: var(--bg-hover); color: var(--primary-light); border-radius: var(--radius-full); font-size: 12px; }
    .post-content { margin-bottom: 16px; color: var(--text-secondary); line-height: 1.7; }
    .post-content h3 { color: var(--text-primary); font-size: 18px; margin-bottom: 8px; }

    .profile-page { padding: 24px; height: 100vh; overflow-y: auto; display: none; }
    .profile-page.active { display: block; }
    .profile-header { display: flex; align-items: center; gap: 24px; margin-bottom: 30px; flex-wrap: wrap; }
    .profile-avatar {
      width: 100px; height: 100px; border-radius: var(--radius-full);
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      display: flex; align-items: center; justify-content: center; font-size: 36px;
      color: white; font-weight: 600; cursor: pointer;
    }
    .profile-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px; margin-bottom: 30px; }
    .stat-card { background: var(--bg-card); border-radius: var(--radius-md); border: 1px solid var(--border); padding: 20px; text-align: center; }
    .stat-number { font-size: 28px; font-weight: 700; color: var(--primary-light); }
    .stat-label { font-size: 14px; color: var(--text-muted); }

    @media (max-width: 768px) {
      .app-container { flex-direction: column; }
      .main-nav { display: flex; }
      .chat-sidebar { width: 100%; height: auto; display: none; }
      .chat-sidebar.active { display: flex; height: calc(100vh - 60px); }
      .chat-main { height: calc(100vh - 60px); display: none; }
      .chat-main.active { display: flex; }
      .community-page, .profile-page { height: calc(100vh - 60px); }
      .message-item { max-width: 85%; }
    }
  </style>
</head>
<body>

<div class="toast" id="toast"></div>

<!-- 修改昵称 -->
<div class="modal" id="nickModal">
  <div class="modal-content">
    <h3 class="modal-title">修改昵称</h3>
    <div class="form-group">
      <label class="form-label">新昵称</label>
      <input type="text" class="form-input" id="newNick" placeholder="请输入新昵称">
    </div>
    <button class="btn btn-primary" onclick="saveNick()">保存</button>
  </div>
</div>

<!-- 修改密码 -->
<div class="modal" id="pwdModal">
  <div class="modal-content">
    <h3 class="modal-title">修改密码</h3>
    <div class="form-group">
      <label class="form-label">原密码</label>
      <input type="password" class="form-input" id="oldPwd" placeholder="原密码">
    </div>
    <div class="form-group">
      <label class="form-label">新密码</label>
      <input type="password" class="form-input" id="newPwd" placeholder="6位以上新密码">
    </div>
    <button class="btn btn-primary" onclick="savePwd()">保存</button>
  </div>
</div>

<!-- 修改头像 -->
<div class="modal" id="avatarModal">
  <div class="modal-content">
    <h3 class="modal-title">修改头像</h3>
    <div class="form-group">
      <input type="file" class="form-input" id="avatarFile" accept="image/*">
    </div>
    <button class="btn btn-primary" onclick="saveAvatar()">上传头像</button>
  </div>
</div>

<!-- 登录注册 -->
<div class="auth-wrapper" id="authWrapper">
  <div class="auth-box active" id="loginBox">
    <div class="auth-header">
      <div class="logo"><i class="fas fa-comments"></i></div>
      <h2>欢迎来到校园聊天</h2>
      <p>登录你的账号，和同学畅聊</p>
    </div>
    <div class="form-group">
      <label class="form-label">学号/账号</label>
      <input type="text" class="form-input" id="loginAccount" placeholder="请输入你的学号/账号">
    </div>
    <div class="form-group">
      <label class="form-label">密码</label>
      <input type="password" class="form-input" id="loginPwd" placeholder="请输入你的密码">
    </div>
    <button class="btn btn-primary" onclick="handleLogin()"><i class="fas fa-right-to-bracket"></i> 立即登录</button>
    <div class="auth-footer">还没有账号？<span onclick="switchAuth('reg')">立即注册</span></div>
  </div>

  <div class="auth-box" id="regBox">
    <div class="auth-header">
      <div class="logo"><i class="fas fa-user-plus"></i></div>
      <h2>注册校园账号</h2>
      <p>填写信息，和全校同学畅聊</p>
    </div>
    <div class="form-group">
      <label class="form-label">学号</label>
      <input type="text" class="form-input" id="regAccount" placeholder="请输入你的学号">
    </div>
    <div class="form-group">
      <label class="form-label">昵称</label>
      <input type="text" class="form-input" id="regNickname" placeholder="请输入你的昵称">
    </div>
    <div class="form-group">
      <label class="form-label">设置密码</label>
      <input type="password" class="form-input" id="regPwd" placeholder="请设置6位以上密码">
    </div>
    <div class="form-group">
      <label class="form-label">确认密码</label>
      <input type="password" class="form-input" id="regConfirmPwd" placeholder="请再次输入密码">
    </div>
    <button class="btn btn-primary" onclick="handleReg()"><i class="fas fa-user-check"></i> 立即注册</button>
    <div class="auth-footer">已有账号？<span onclick="switchAuth('login')">返回登录</span></div>
  </div>
</div>

<!-- 主界面 -->
<div class="app-container" id="appMain">
  <div class="main-nav">
    <button class="main-nav-item active" onclick="switchMobileTab('chat')"><i class="fas fa-comments"></i> 聊天</button>
    <button class="main-nav-item" onclick="switchMobileTab('community')"><i class="fas fa-house"></i> 社区</button>
    <button class="main-nav-item" onclick="switchMobileTab('profile')"><i class="fas fa-user"></i> 我的</button>
  </div>

  <div class="chat-sidebar" id="chatSidebar">
    <div class="sidebar-header">
      <div class="user-info-bar">
        <div class="user-avatar" id="sidebarAvatar">U</div>
        <div class="user-name" id="sidebarName">用户名</div>
      </div>
      <input type="text" class="search-box" id="chatSearch" placeholder="搜索聊天/好友..." oninput="searchChat()">
    </div>
    <div class="sidebar-tabs">
      <div class="sidebar-tab active" onclick="switchSidebarTab('session')">消息</div>
      <div class="sidebar-tab" onclick="switchSidebarTab('friend')">好友</div>
    </div>
    <div class="session-wrap">
      <div class="session-group" id="sessionList">
        <div class="group-title">最近聊天</div>
        <div class="session-item active" onclick="switchChat('public','校园公共频道','channel')">
          <div class="session-avatar"><i class="fas fa-users"></i></div>
          <div class="session-info">
            <div class="session-name">校园公共频道</div>
            <div class="session-last-msg">全校同学都在这里畅聊</div>
          </div>
        </div>
      </div>
      <div class="session-group" id="friendList" style="display:none;">
        <div class="group-title">公共频道</div>
        <div class="session-item" onclick="switchChat('public','校园公共频道','channel')">
          <div class="session-avatar"><i class="fas fa-users"></i></div>
          <div class="session-info">
            <div class="session-name">校园公共频道</div>
            <div class="session-last-msg">全校同学都在这里</div>
          </div>
        </div>
        <div class="group-title">我的好友</div>
        <div id="friendUserList"></div>
      </div>
    </div>
  </div>

  <div class="chat-main" id="chatMain">
    <div class="chat-header">
      <div class="chat-header-avatar"><i class="fas fa-users"></i></div>
      <div class="chat-header-info">
        <h4>校园公共频道</h4>
        <div class="chat-header-status">在线人数：128人</div>
      </div>
    </div>
    <div class="chat-content" id="chatContent">
      <div class="message-item">
        <div class="message-avatar">管</div>
        <div class="message-bubble-wrap">
          <div class="message-bubble">欢迎大家来到校园公共频道，文明交流，友好相处哦~</div>
          <div class="message-time">今天 09:00</div>
        </div>
      </div>
    </div>
    <div class="chat-input-box">
      <div class="chat-input-wrapper">
        <textarea class="chat-input" id="chatInput" placeholder="输入消息，按Ctrl+Enter换行，Enter发送..."></textarea>
        <button class="send-btn" onclick="sendChatMessage()">发送</button>
      </div>
    </div>
  </div>

  <div class="community-page" id="communityPage">
    <div class="card">
      <div class="card-header">
        <h3 class="card-title"><i class="fas fa-pen-to-square"></i> 发布新帖</h3>
      </div>
      <input type="text" class="publish-input" id="postTitle" placeholder="输入帖子标题...">
      <textarea class="publish-input" id="postContent" placeholder="分享你的校园生活、问题、趣事..." rows="3"></textarea>
      <div class="publish-footer">
        <div class="tag-select">
          <div class="tag-item active" onclick="selectTag(this)">校园日常</div>
          <div class="tag-item" onclick="selectTag(this)">学习交流</div>
          <div class="tag-item" onclick="selectTag(this)">求助问答</div>
          <div class="tag-item" onclick="selectTag(this)">社团招新</div>
          <div class="tag-item" onclick="selectTag(this)">找搭子</div>
        </div>
        <button class="btn btn-primary btn-sm" onclick="handlePublish()"><i class="fas fa-paper-plane"></i> 发布帖子</button>
      </div>
    </div>
    <div class="card">
      <div class="card-header">
        <h3 class="card-title"><i class="fas fa-list"></i> 社区动态</h3>
      </div>
      <div id="postList"></div>
    </div>
  </div>

  <div class="profile-page" id="profilePage">
    <div class="card">
      <div class="profile-header">
        <div class="profile-avatar" id="profileAvatar" onclick="openAvatarModal()">U</div>
        <div class="profile-info">
          <h2 id="profileNickname">校园用户</h2>
          <p id="profileAccount">学号：20250001</p>
          <p id="profileRegTime">注册时间：2026-01-01</p>
        </div>
      </div>
      <div class="profile-stats">
        <div class="stat-card"><div class="stat-number" id="postCount">0</div><div class="stat-label">发布帖子</div></div>
        <div class="stat-card"><div class="stat-number" id="msgCount">0</div><div class="stat-label">发送消息</div></div>
        <div class="stat-card"><div class="stat-number" id="friendCount">0</div><div class="stat-label">好友数量</div></div>
      </div>
      <button class="btn btn-primary" style="margin-bottom:10px" onclick="openNickModal()"><i class="fas fa-user-edit"></i> 修改昵称</button>
      <button class="btn btn-primary" style="margin-bottom:10px" onclick="openPwdModal()"><i class="fas fa-lock"></i> 修改密码</button>
      <button class="btn btn-primary" onclick="logout()"><i class="fas fa-right-from-bracket"></i> 退出登录</button>
    </div>
  </div>
</div>

<script>
// 违禁词
const badWords = ['操','傻逼','垃圾','去死','滚','妈的','草','靠','日','屌','骚逼','母狗'];
function filterBadWords(str) {
  if(!str) return '';
  badWords.forEach(w => { str = str.replaceAll(w, '*'.repeat(w.length)); });
  return str;
}

// 弹窗控制
function openNickModal(){document.getElementById('nickModal').classList.add('show')}
function openPwdModal(){document.getElementById('pwdModal').classList.add('show')}
function openAvatarModal(){document.getElementById('avatarModal').classList.add('show')}
function closeAllModal(){document.querySelectorAll('.modal').forEach(m=>m.classList.remove('show'))}

// 全局变量
let currentUser = null;
let currentTag = '校园日常';
let currentChat = {id:'public',name:'校园公共频道',type:'channel'};
let currentSidebarTab = 'session';

window.onload = function(){
  initData();
  checkLogin();
  document.getElementById('chatInput').addEventListener('keydown',e=>{
    if(e.key==='Enter'&&!e.ctrlKey){e.preventDefault();sendChatMessage();}
  });
};

// 初始化数据
function initData(){
  if(!localStorage.getItem('campus_users')){
    localStorage.setItem('campus_users',JSON.stringify([
      {account:'admin',nickname:'系统管理员',password:'admin123',avatar:'',role:'admin',regTime:formatTime(new Date())}
    ]));
  }
  if(!localStorage.getItem('campus_posts')) localStorage.setItem('campus_posts','[]');
  if(!localStorage.getItem('campus_public_chat')) localStorage.setItem('campus_public_chat','[]');
  if(!localStorage.getItem('campus_private_chat')) localStorage.setItem('campus_private_chat','{}');
  if(!localStorage.getItem('campus_session_list')) localStorage.setItem('campus_session_list','[]');
  if(!localStorage.getItem('campus_chat_read')) localStorage.setItem('campus_chat_read','{}');
}

// 检查登录
function checkLogin(){
  const user = JSON.parse(localStorage.getItem('campus_currentUser'));
  if(user){
    currentUser = user;
    document.getElementById('authWrapper').classList.add('hidden');
    document.getElementById('appMain').classList.add('active');
    refreshUserUI();
    renderSessionList();
    renderFriendList();
    renderChatMessages();
    renderPostList();
    updateStatCount();
  }else{
    document.getElementById('appMain').classList.remove('active');
    document.getElementById('authWrapper').classList.remove('hidden');
    document.getElementById('loginBox').classList.add('active');
  }
}

// 刷新用户界面
function refreshUserUI(){
  if(!currentUser) return;
  document.getElementById('sidebarAvatar').textContent = currentUser.nickname.charAt(0);
  document.getElementById('sidebarName').textContent = currentUser.nickname;
  document.getElementById('profileAvatar').textContent = currentUser.nickname.charAt(0);
  document.getElementById('profileNickname').textContent = currentUser.nickname;
  document.getElementById('profileAccount').textContent = '学号：'+currentUser.account;
  document.getElementById('profileRegTime').textContent = '注册时间：'+currentUser.regTime;
}

// 提示
function showToast(msg,type='success'){
  const t=document.getElementById('toast');
  t.textContent=msg; t.className='toast '+type;
  t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'),2500);
}

// 时间
function formatTime(d){
  const y=d.getFullYear(),m=String(d.getMonth()+1).padStart(2,'0'),dd=String(d.getDate()).padStart(2,'0');
  const h=String(d.getHours()).padStart(2,'0'),mm=String(d.getMinutes()).padStart(2,'0');
  return `${y}-${m}-${dd} ${h}:${mm}`;
}
function formatChatTime(ts){
  const d=new Date(ts),now=new Date(),today=new Date(now.getFullYear(),now.getMonth(),now.getDate());
  const yest=new Date(today-86400000),msgd=new Date(d.getFullYear(),d.getMonth(),d.getDate());
  const hh=String(d.getHours()).padStart(2,'0'),mm=String(d.getMinutes()).padStart(2,'0');
  if(msgd.getTime()===today.getTime()) return `今天 ${hh}:${mm}`;
  if(msgd.getTime()===yest.getTime()) return `昨天 ${hh}:${mm}`;
  return `${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')} ${hh}:${mm}`;
}

// 登录注册切换
function switchAuth(t){
  document.getElementById('loginBox').classList.remove('active');
  document.getElementById('regBox').classList.remove('active');
  document.getElementById(t+'Box').classList.add('active');
}

// 手机端切换
function switchMobileTab(t){
  document.querySelectorAll('.main-nav-item').forEach(i=>i.classList.remove('active'));
  event.target.classList.add('active');
  document.getElementById('chatSidebar').classList.remove('active');
  document.getElementById('chatMain').classList.remove('active');
  document.getElementById('communityPage').classList.remove('active');
  document.getElementById('profilePage').classList.remove('active');
  if(t==='chat') document.getElementById('chatSidebar').classList.add('active');
  if(t==='community') document.getElementById('communityPage').classList.add('active');
  if(t==='profile') document.getElementById('profilePage').classList.add('active');
}

// 侧边栏切换
function switchSidebarTab(t){
  currentSidebarTab=t;
  document.querySelectorAll('.sidebar-tab').forEach(i=>i.classList.remove('active'));
  event.target.classList.add('active');
  document.getElementById('sessionList').style.display=t==='session'?'block':'none';
  document.getElementById('friendList').style.display=t==='friend'?'block':'none';
}

// 选择标签
function selectTag(el){
  document.querySelectorAll('.tag-item').forEach(i=>i.classList.remove('active'));
  el.classList.add('active');
  currentTag=el.textContent;
}

// 登录
function handleLogin(){
  const account=document.getElementById('loginAccount').value.trim();
  const pwd=document.getElementById('loginPwd').value.trim();
  const users=JSON.parse(localStorage.getItem('campus_users'));
  const u=users.find(x=>x.account===account);
  if(!account||!pwd) return showToast('请输入账号密码','warning');
  if(!u) return showToast('账号不存在','error');
  if(u.password!==pwd) return showToast('密码错误','error');
  localStorage.setItem('campus_currentUser',JSON.stringify(u));
  showToast('登录成功');
  setTimeout(checkLogin,500);
}

// 注册
function handleReg(){
  const account=document.getElementById('regAccount').value.trim();
  const nick=filterBadWords(document.getElementById('regNickname').value.trim());
  const pwd=document.getElementById('regPwd').value.trim();
  const cpwd=document.getElementById('regConfirmPwd').value.trim();
  const users=JSON.parse(localStorage.getItem('campus_users'));
  if(!account||!nick||!pwd||!cpwd) return showToast('请填写完整','warning');
  if(users.find(x=>x.account===account)) return showToast('账号已存在','warning');
  if(pwd.length<6) return showToast('密码至少6位','error');
  if(pwd!==cpwd) return showToast('两次密码不一致','error');
  users.push({account,nickname:nick,password:pwd,avatar:'',role:'user',regTime:formatTime(new Date())});
  localStorage.setItem('campus_users',JSON.stringify(users));
  showToast('注册成功');
  switchAuth('login');
}

// 退出
function logout(){
  localStorage.removeItem('campus_currentUser');
  currentUser=null;
  showToast('已退出');
  setTimeout(checkLogin,500);
}

// 发布帖子
function handlePublish(){
  const title=filterBadWords(document.getElementById('postTitle').value.trim());
  const content=filterBadWords(document.getElementById('postContent').value.trim());
  if(!title||!content) return showToast('标题内容不能为空','warning');
  const posts=JSON.parse(localStorage.getItem('campus_posts'));
  posts.unshift({
    id:Date.now(),title,content,tag:currentTag,
    account:currentUser.account,nickname:currentUser.nickname,
    time:formatTime(new Date()),likes:0
  });
  localStorage.setItem('campus_posts',JSON.stringify(posts));
  showToast('发布成功');
  document.getElementById('postTitle').value='';
  document.getElementById('postContent').value='';
  renderPostList();
  updateStatCount();
}

// 渲染帖子
function renderPostList(){
  const posts=JSON.parse(localStorage.getItem('campus_posts'));
  let html='';
  posts.forEach(p=>{
    html+=`
    <div class="post-item">
      <div class="post-header">
        <div class="user-avatar">${p.nickname.charAt(0)}</div>
        <div class="post-user-info">
          <div class="post-username">${p.nickname}</div>
          <div class="post-time">${p.time}</div>
        </div>
        <div class="post-tag">${p.tag}</div>
      </div>
      <div class="post-content">
        <h3>${p.title}</h3>
        <p>${p.content}</p>
      </div>
    </div>`;
  });
  document.getElementById('postList').innerHTML=html;
}

// 聊天相关
function getChatKey(a1,a2){return [a1,a2].sort().join('_');}
function switchChat(id,name,type){
  currentChat={id,name,type};
  document.querySelectorAll('.session-item').forEach(i=>i.classList.remove('active'));
  event.target.closest('.session-item').classList.add('active');
  renderChatMessages();
  if(window.innerWidth<=768){
    document.getElementById('chatSidebar').classList.remove('active');
    document.getElementById('chatMain').classList.add('active');
  }
}

// 发送消息
function sendChatMessage(){
  const content=filterBadWords(document.getElementById('chatInput').value.trim());
  if(!content) return;
  const now=Date.now();
  const msg={id:now,from:currentUser.account,fromName:currentUser.nickname,content,time:now,to:currentChat.id};
  if(currentChat.type==='channel'){
    const c=JSON.parse(localStorage.getItem('campus_public_chat'));
    c.push(msg);
    localStorage.setItem('campus_public_chat',JSON.stringify(c));
  }else{
    const c=JSON.parse(localStorage.getItem('campus_private_chat'));
    const k=getChatKey(currentUser.account,currentChat.id);
    if(!c[k])c[k]=[];c[k].push(msg);
    localStorage.setItem('campus_private_chat',JSON.stringify(c));
  }
  document.getElementById('chatInput').value='';
  renderChatMessages();
  updateStatCount();
}

// 渲染消息
function renderChatMessages(){
  const el=document.getElementById('chatContent');
  let ms=[];
  if(currentChat.type==='channel') ms=JSON.parse(localStorage.getItem('campus_public_chat'));
  else{
    const c=JSON.parse(localStorage.getItem('campus_private_chat'));
    const k=getChatKey(currentUser.account,currentChat.id);
    ms=c[k]||[];
  }
  let html='';
  let lastDate=null;
  ms.forEach(m=>{
    const isSelf=m.from===currentUser.account;
    const d=new Date(m.time).toDateString();
    if(d!==lastDate){html+=`<div class="time-split">${formatChatTime(m.time).split(' ')[0]}</div>`;lastDate=d;}
    html+=`
    <div class="message-item ${isSelf?'self':''}">
      <div class="message-avatar">${isSelf?currentUser.nickname.charAt(0):m.fromName.charAt(0)}</div>
      <div class="message-bubble-wrap">
        <div class="message-bubble">${m.content}</div>
        <div class="message-time">${formatChatTime(m.time).split(' ')[1]}</div>
      </div>
    </div>`;
  });
  el.innerHTML=html;
  el.scrollTop=el.scrollHeight;
}

// 渲染会话
function renderSessionList(){
  const list=JSON.parse(localStorage.getItem('campus_session_list'));
  let html='<div class="group-title">最近聊天</div>';
  html+=`<div class="session-item ${currentChat.id==='public'?'active':''}" onclick="switchChat('public','校园公共频道','channel')">
    <div class="session-avatar"><i class="fas fa-users"></i></div>
    <div class="session-info"><div class="session-name">校园公共频道</div><div class="session-last-msg">全校同学都在这里畅聊</div></div>
  </div>`;
  list.forEach(s=>{
    html+=`
    <div class="session-item ${currentChat.id===s.targetId?'active':''}" onclick="switchChat('${s.targetId}','${s.targetName}','user')">
      <div class="session-avatar">${s.targetName.charAt(0)}</div>
      <div class="session-info">
        <div class="session-name">${s.targetName}</div>
        <div class="session-last-msg">${s.lastMsg}</div>
      </div>
    </div>`;
  });
  document.getElementById('sessionList').innerHTML=html;
}

// 渲染好友
function renderFriendList(){
  const users=JSON.parse(localStorage.getItem('campus_users'));
  const others=users.filter(u=>u.account!==currentUser.account);
  let html='';
  others.forEach(u=>{
    html+=`
    <div class="session-item" onclick="switchChat('${u.account}','${u.nickname}','user')">
      <div class="session-avatar">${u.nickname.charAt(0)}</div>
      <div class="session-info">
        <div class="session-name">${u.nickname}</div>
        <div class="session-last-msg">学号：${u.account}</div>
      </div>
    </div>`;
  });
  document.getElementById('friendUserList').innerHTML=html;
  document.getElementById('friendCount').textContent=others.length;
}

// 搜索
function searchChat(){
  const kw=document.getElementById('chatSearch').value.toLowerCase();
  document.querySelectorAll('#sessionList .session-item, #friendUserList .session-item').forEach(i=>{
    const n=i.querySelector('.session-name').textContent.toLowerCase();
    const a=i.querySelector('.session-last-msg').textContent.toLowerCase();
    i.style.display=n.includes(kw)||a.includes(kw)?'flex':'none';
  });
}

// 统计
function updateStatCount(){
  const posts=JSON.parse(localStorage.getItem('campus_posts'));
  const users=JSON.parse(localStorage.getItem('campus_users'));
  const chat=JSON.parse(localStorage.getItem('campus_public_chat'));
  const pChat=JSON.parse(localStorage.getItem('campus_private_chat'));
  document.getElementById('postCount').textContent=posts.filter(p=>p.account===currentUser.account).length;
  let msgCount=chat.filter(m=>m.from===currentUser.account).length;
  Object.values(pChat).forEach(c=>{msgCount+=c.filter(m=>m.from===currentUser.account).length});
  document.getElementById('msgCount').textContent=msgCount;
}

// ==================== 你要的新增功能 ====================
// 保存昵称
function saveNick(){
  const newNick=filterBadWords(document.getElementById('newNick').value.trim());
  if(!newNick) return showToast('昵称不能为空','warning');
  const users=JSON.parse(localStorage.getItem('campus_users'));
  const idx=users.findIndex(x=>x.account===currentUser.account);
  users[idx].nickname=newNick;
  localStorage.setItem('campus_users',JSON.stringify(users));
  currentUser.nickname=newNick;
  localStorage.setItem('campus_currentUser',JSON.stringify(currentUser));
  refreshUserUI();
  closeAllModal();
  showToast('昵称修改成功');
}

// 保存密码
function savePwd(){
  const old=document.getElementById('oldPwd').value.trim();
  const newP=document.getElementById('newPwd').value.trim();
  if(old!==currentUser.password) return showToast('原密码错误','error');
  if(newP.length<6) return showToast('密码至少6位','error');
  const users=JSON.parse(localStorage.getItem('campus_users'));
  const idx=users.findIndex(x=>x.account===currentUser.account);
  users[idx].password=newP;
  localStorage.setItem('campus_users',JSON.stringify(users));
  currentUser.password=newP;
  localStorage.setItem('campus_currentUser',JSON.stringify(currentUser));
  closeAllModal();
  showToast('密码修改成功');
}

// 保存头像
function saveAvatar(){
  const file=document.getElementById('avatarFile').files[0];
  if(!file) return showToast('请选择图片','warning');
  const reader=new FileReader();
  reader.onload=e=>{
    const users=JSON.parse(localStorage.getItem('campus_users'));
    const idx=users.findIndex(x=>x.account===currentUser.account);
    users[idx].avatar=e.target.result;
    localStorage.setItem('campus_users',JSON.stringify(users));
    currentUser.avatar=e.target.result;
    localStorage.setItem('campus_currentUser',JSON.stringify(currentUser));
    refreshUserUI();
    closeAllModal();
    showToast('头像修改成功');
  };
  reader.readAsDataURL(file);
}
</script>
</body>
</html>
